<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fonte de Vida - Sistema de Pedidos</title>
    
    <!-- PWA Configuration -->
    
    <meta name="theme-color" content="#2196F3">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Fonte de Vida">
    
    <!-- Ícones PWA -->
    <link rel="manifest" href="/manifest.json">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #2196F3, #21CBF3);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .header .app-status {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            backdrop-filter: blur(10px);
        }

        .install-prompt {
            display: block;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            padding: 15px;
            text-align: center;
            border: none;
            width: 100%;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
            100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
        }

        .install-instructions {
            background: #e3f2fd;
            border: 2px solid #2196F3;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            font-family: monospace;
            line-height: 1.6;
            display: none;
        }

        .chrome-os-help {
            background: linear-gradient(45deg, #ff9800, #f57c00);
            color: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
        }

        .install-prompt:hover {
            background: linear-gradient(45deg, #45a049, #4CAF50);
        }

        .offline-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 10px 15px;
            border-radius: 25px;
            font-size: 0.9em;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1001;
            display: none;
        }

        .offline-indicator.offline {
            background: #ff9800;
            display: block;
        }

        .offline-indicator.online {
            background: #4CAF50;
            display: block;
            animation: fadeInOut 3s ease;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(20px); }
            20% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 3px solid #e9ecef;
        }

        .nav-tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            background: none;
            border: none;
            font-size: 1.1em;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .nav-tab.active {
            color: #2196F3;
            border-bottom-color: #2196F3;
            background: white;
        }

        .nav-tab:hover {
            background: #e9ecef;
        }

        .content {
            padding: 40px;
            min-height: 600px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Página Principal */
        .new-order-btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 25px 50px;
            font-size: 1.5em;
            font-weight: bold;
            border-radius: 15px;
            cursor: pointer;
            display: block;
            margin: 0 auto 40px;
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .new-order-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(76, 175, 80, 0.4);
        }

        .search-filter {
            margin-bottom: 30px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 250px;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #2196F3;
        }

        .clients-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .client-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 25px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .client-card:hover {
            border-color: #2196F3;
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .client-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .client-address {
            color: #666;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .client-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #2196F3;
            color: white;
        }

        .btn-primary:hover {
            background: #1976D2;
        }

        .btn-success {
            background: #4CAF50;
            color: white;
        }

        .btn-success:hover {
            background: #45a049;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .modal-header h2 {
            color: #333;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .close-btn {
            position: absolute;
            top: 20px;
            right: 25px;
            background: none;
            border: none;
            font-size: 2em;
            cursor: pointer;
            color: #999;
        }

        .close-btn:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
            transform: translateY(-2px);
        }

        .form-input.required {
            border-left: 4px solid #4CAF50;
        }

        .form-input.invalid {
            border-color: #f44336;
            box-shadow: 0 0 0 3px rgba(244, 67, 54, 0.1);
        }

        .form-input.valid {
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        /* Tooltips */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Indicadores visuais */
        .field-status {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2em;
        }

        .form-group {
            margin-bottom: 25px;
            position: relative;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            position: relative;
        }

        .required-star {
            color: #f44336;
            margin-left: 4px;
        }

        .help-text {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        /* Produtos no pedido */
        .products-section {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .product-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 15px;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .add-product-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .remove-product-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
        }

        /* Dashboard */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1.2em;
            opacity: 0.9;
        }

        /* Produtos */
        .products-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .products-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .products-table th,
        .products-table td {
            padding: 20px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .products-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .products-table tr:hover {
            background: #f8f9fa;
        }

        /* Cupom Não Fiscal - Estilo Tradicional */
        .receipt-content {
            font-family: 'Courier New', monospace;
            background: white;
            border: 1px solid #ccc;
            padding: 10px;
            margin: 20px auto;
            white-space: pre-line;
            font-size: 11px;
            line-height: 1.2;
            max-width: 280px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .receipt-line {
            text-align: center;
            margin: 2px 0;
        }

        .receipt-separator {
            text-align: center;
            margin: 8px 0;
            font-weight: normal;
        }

        .receipt-left {
            text-align: left;
        }

        .receipt-center {
            text-align: center;
        }

        .receipt-right {
            text-align: right;
        }

        .receipt-bold {
            font-weight: bold;
        }

        .receipt-small {
            font-size: 9px;
        }

        .receipt-medium {
            font-size: 12px;
        }

        .receipt-large {
            font-size: 14px;
        }

        .receipt-item-line {
            display: flex;
            justify-content: space-between;
            margin: 1px 0;
            font-size: 10px;
        }

        .receipt-total-line {
            display: flex;
            justify-content: space-between;
            margin: 2px 0;
            font-weight: bold;
            border-top: 1px solid #000;
            padding-top: 4px;
        }

        /* ===== MODAIS MODERNOS ===== */
        .modern-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000;
            animation: fadeIn 0.3s ease;
        }

        .modern-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modern-modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }

        .modern-modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            animation: modalPop 0.3s ease forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes modalPop {
            to { transform: scale(1); }
        }

        .modal-icon {
            font-size: 4em;
            margin-bottom: 20px;
            display: block;
        }

        .modern-modal-content h3 {
            font-size: 1.8em;
            margin-bottom: 15px;
            color: #333;
            font-weight: 600;
        }

        .modern-modal-content p {
            font-size: 1.1em;
            line-height: 1.6;
            color: #666;
            margin-bottom: 30px;
            white-space: pre-line;
        }

        .modern-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 10px;
            min-width: 120px;
        }

        .modern-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(33, 150, 243, 0.3);
        }

        .modern-btn.primary {
            background: linear-gradient(45deg, #2196F3, #21CBF3);
        }

        .modern-btn.secondary {
            background: #f5f5f5;
            color: #666;
        }

        .modern-btn.secondary:hover {
            background: #e0e0e0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .modern-btn.success {
            background: linear-gradient(45deg, #4CAF50, #45a049);
        }

        .modern-btn.warning {
            background: linear-gradient(45deg, #ff9800, #f57c00);
        }

        .modern-btn.danger {
            background: linear-gradient(45deg, #f44336, #d32f2f);
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* ===== TOAST NOTIFICATIONS ===== */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 3000;
            max-width: 400px;
        }

        .toast {
            background: white;
            color: #333;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border-left: 5px solid #2196F3;
            transform: translateX(450px);
            animation: toastSlideIn 0.3s ease forwards;
            position: relative;
            overflow: hidden;
        }

        .toast.success {
            border-left-color: #4CAF50;
        }

        .toast.warning {
            border-left-color: #ff9800;
        }

        .toast.error {
            border-left-color: #f44336;
        }

        .toast::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: linear-gradient(90deg, #2196F3, #21CBF3);
            animation: toastProgress 4s linear forwards;
        }

        .toast.success::before {
            background: linear-gradient(90deg, #4CAF50, #45a049);
        }

        .toast.warning::before {
            background: linear-gradient(90deg, #ff9800, #f57c00);
        }

        .toast.error::before {
            background: linear-gradient(90deg, #f44336, #d32f2f);
        }

        .install-instructions {
            display: none;
        }

        @keyframes toastSlideIn {
            to { transform: translateX(0); }
        }

        @keyframes toastSlideOut {
            to { transform: translateX(450px); opacity: 0; }
        }

        @keyframes toastProgress {
            to { width: 100%; }
        }

        .toast-icon {
            font-size: 1.5em;
            margin-right: 15px;
            vertical-align: middle;
        }

        .toast-content {
            display: inline-block;
            vertical-align: middle;
            max-width: calc(100% - 50px);
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 1.1em;
        }

        .toast-message {
            color: #666;
            font-size: 0.95em;
            line-height: 1.4;
        }

        .toast-close {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.2em;
            color: #999;
            cursor: pointer;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toast-close:hover {
            color: #333;
        }

        /* Estilos de impressão - Cupom Não Fiscal */
        @media print {
            body * {
                visibility: hidden;
            }
            
            .receipt-content,
            .receipt-content * {
                visibility: visible;
            }
            
            .receipt-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 80mm;
                max-width: 80mm;
                margin: 0;
                padding: 5mm;
                border: none;
                box-shadow: none;
                font-size: 10px;
                background: white !important;
            }
            
            .receipt-total-line {
                border-top: 1px solid #000 !important;
            }
            
            .modal,
            .close-btn,
            button {
                display: none !important;
            }
        }

        /* Responsivo */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .product-item {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .search-filter {
                flex-direction: column;
            }
            
            .clients-grid {
                grid-template-columns: 1fr;
            }

            .modern-modal-content {
                padding: 30px 20px;
                margin: 20px;
            }

            .modal-buttons {
                flex-direction: column;
            }

            .modern-btn {
                margin: 5px 0;
                width: 100%;
            }

            .toast-container {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
            }

            .toast {
                transform: translateY(-100px);
                animation: toastSlideInMobile 0.3s ease forwards;
            }

            @keyframes toastSlideInMobile {
                to { transform: translateY(0); }
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="install-prompt" id="installPrompt">
            📱 Instalar Aplicativo - Clique aqui para usar como programa nativo!
        </button>
        
        <div class="chrome-os-help" id="chromeOSHelp" style="display: none;">
            🖥️ Chrome OS Detectado! Veja as instruções abaixo para instalar ⬇️
        </div>
        
        <div class="install-instructions" id="installInstructions" style="display: none;">
            <h3>🚀 Como Instalar no Chrome OS Flex:</h3>
            
            <h4>📱 MÉTODO 1 - Servidor Local (RECOMENDADO):</h4>
            <code>
            1. Aperte <strong>Ctrl + Alt + T</strong> (Terminal)<br>
            2. Digite: <strong>python3 -m http.server 8000</strong><br>
            3. Abra nova aba: <strong>localhost:8000</strong><br>
            4. Clique no arquivo HTML<br>
            5. ✅ Agora o "Criar atalho" funciona!
            </code>
            
            <h4>🔧 MÉTODO 2 - Via Arquivo:</h4>
            <code>
            1. Chrome → <strong>Configurações</strong><br>
            2. <strong>Aplicativos</strong> → <strong>Gerenciar seus aplicativos</strong><br>
            3. Clique <strong>"+ Adicionar"</strong><br>
            4. Cole: <strong>file:///home/chronos/user/Downloads/fonte-vida.html</strong><br>
            5. Nome: <strong>Fonte de Vida</strong>
            </code>
            
            <h4>⚡ MÉTODO 3 - Extensão PWA:</h4>
            <code>
            1. Chrome Web Store → Pesquise <strong>"PWA Builder"</strong><br>
            2. Instale a extensão<br>
            3. Abra o arquivo HTML<br>
            4. Clique na extensão → <strong>"Install as PWA"</strong>
            </code>
        </div>
        
        <div class="header">
            <div class="app-status" id="appStatus">💧 Web App</div>
            <h1>💧 Fonte de Vida</h1>
            <p>Sistema de Gerenciamento de Pedidos</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showPage('home')">📋 Pedidos</button>
            <button class="nav-tab" onclick="showPage('dashboard')">📊 Relatórios</button>
            <button class="nav-tab" onclick="showPage('products')">🛍️ Produtos</button>
            <button class="nav-tab" onclick="showPage('settings')">⚙️ Configurações</button>
        </div>

        <div class="content">
            <!-- Página Principal -->
            <div class="page active" id="home">
                <button class="new-order-btn" onclick="openOrderModal()">
                    ➕ Fazer Novo Pedido
                </button>

                <div class="search-filter">
                    <input type="text" class="search-input" placeholder="🔍 Buscar por nome do cliente..." id="searchName" oninput="filterClients()">
                    <input type="text" class="search-input" placeholder="🏠 Buscar por rua..." id="searchStreet" oninput="filterClients()">
                </div>

                <div class="clients-grid" id="clientsGrid">
                    <!-- Clientes serão carregados aqui -->
                </div>
            </div>

            <!-- Dashboard -->
            <div class="page" id="dashboard">
                <h2 style="margin-bottom: 30px; color: #333;">📊 Relatórios de Vendas</h2>
                
                <div class="dashboard-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="todayOrders">0</div>
                        <div class="stat-label">Pedidos Hoje</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="weekOrders">0</div>
                        <div class="stat-label">Pedidos na Semana</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="monthOrders">0</div>
                        <div class="stat-label">Pedidos no Mês</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="todayRevenue">R$ 0</div>
                        <div class="stat-label">Faturamento Hoje</div>
                    </div>
                </div>

                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <button class="btn btn-success" onclick="exportCSV()">📥 Baixar Relatório CSV</button>
                    <button class="btn btn-primary" onclick="exportBackup()">💾 Fazer Backup Completo</button>
                    <button class="btn" onclick="importBackup()" style="background: #ff9800; color: white;">📂 Restaurar Backup</button>
                    <input type="file" id="backupFileInput" accept=".json" style="display: none;" onchange="handleBackupFile(this)">
                </div>
            </div>

            <!-- Produtos -->
            <div class="page" id="products">
                <div class="products-header">
                    <h2 style="color: #333;">🛍️ Gerenciar Produtos</h2>
                    <button class="btn btn-primary" onclick="openProductModal()">➕ Adicionar Produto</button>
                </div>

                <table class="products-table">
                    <thead>
                        <tr>
                            <th>Nome do Produto</th>
                            <th>Preço</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="productsTable">
                        <!-- Produtos serão carregados aqui -->
                    </tbody>
                </table>
            </div>

            <!-- Configurações -->
            <div class="page" id="settings">
                <h2 style="margin-bottom: 30px; color: #333;">⚙️ Configurações da Empresa</h2>
                
                <form id="settingsForm" style="max-width: 600px;">
                    <div class="form-group">
                        <label class="form-label">🏢 Nome da Empresa <span class="required-star">*</span></label>
                        <input type="text" class="form-input required" id="companyName" value="Fonte de Vida" required placeholder="Ex: Distribuidora Fonte de Vida">
                        <div class="help-text">Nome que aparecerá nas notas</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">📄 CNPJ</label>
                        <input type="text" class="form-input" id="companyCNPJ" placeholder="00.000.000/0001-00" maxlength="18">
                        <div class="help-text">CNPJ da empresa (opcional)</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">🏠 Endereço Completo</label>
                        <input type="text" class="form-input" id="companyAddress" placeholder="Rua das Águas, 123 - Centro - São Paulo/SP">
                        <div class="help-text">Endereço que aparecerá nas notas</div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">📞 Telefone</label>
                            <input type="tel" class="form-input" id="companyPhone" placeholder="(11) 99999-9999" maxlength="15">
                            <div class="help-text">Telefone para contato</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">📧 E-mail</label>
                            <input type="email" class="form-input" id="companyEmail" placeholder="contato@fontedevida.com">
                            <div class="help-text">E-mail da empresa</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">💬 Mensagem no Rodapé da Nota</label>
                        <textarea class="form-input" id="footerMessage" rows="3" placeholder="Obrigado pela preferência! Volte sempre!"></textarea>
                        <div class="help-text">Mensagem que aparece no final da nota</div>
                    </div>

                    <div style="text-align: center; margin-top: 30px;">
                        <button type="submit" class="btn btn-success" style="padding: 15px 40px; font-size: 1.2em;">✅ Salvar Configurações</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Pedido -->
    <div class="modal" id="orderModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeOrderModal()">&times;</button>
            <div class="modal-header">
                <h2>📝 Novo Pedido</h2>
                <p>Preencha os dados do cliente e selecione os produtos</p>
            </div>

            <form id="orderForm">
                <h3 style="margin-bottom: 20px; color: #333;">👤 Dados do Cliente</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Nome Completo <span class="required-star">*</span></label>
                        <input type="text" class="form-input required" id="clientName" required placeholder="Ex: João da Silva">
                        <div class="help-text">Nome completo do cliente</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Telefone</label>
                        <input type="tel" class="form-input" id="clientPhone" placeholder="(11) 99999-9999" maxlength="15">
                        <div class="help-text">Telefone com DDD</div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Endereço <span class="required-star">*</span></label>
                    <input type="text" class="form-input required" id="clientAddress" required placeholder="Ex: Rua das Flores, 123">
                    <div class="help-text">Rua, número</div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Complemento</label>
                        <input type="text" class="form-input" id="clientComplement" placeholder="Ex: Apto 45, Bloco B">
                        <div class="help-text">Apartamento, casa, etc.</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Bairro</label>
                        <input type="text" class="form-input" id="clientNeighborhood" placeholder="Ex: Centro">
                        <div class="help-text">Nome do bairro</div>
                    </div>
                </div>

                <div class="products-section">
                    <h3 style="margin-bottom: 20px; color: #333;">🛍️ Produtos do Pedido</h3>
                    <button type="button" class="add-product-btn" onclick="addProductToOrder()">➕ Adicionar Produto</button>
                    <div id="orderProducts">
                        <!-- Produtos do pedido serão adicionados aqui -->
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">📝 Observações</label>
                    <textarea class="form-input" id="orderNotes" rows="3" placeholder="Observações adicionais..."></textarea>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button type="submit" class="btn btn-success" style="padding: 15px 40px; font-size: 1.2em;">✅ Confirmar Pedido</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Produto -->
    <div class="modal" id="productModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeProductModal()">&times;</button>
            <div class="modal-header">
                <h2 id="productModalTitle">➕ Adicionar Produto</h2>
            </div>

            <form id="productForm">
                <div class="form-group">
                    <label class="form-label">Nome do Produto <span class="required-star">*</span></label>
                    <input type="text" class="form-input required" id="productName" required placeholder="Ex: Galão 20L">
                    <div class="help-text">Nome que aparecerá nos pedidos</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Preço (R$) <span class="required-star">*</span></label>
                    <input type="text" class="form-input required" id="productPrice" required placeholder="R$ 0,00">
                    <div class="help-text">Preço padrão do produto</div>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button type="submit" class="btn btn-success">✅ Salvar Produto</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Nota -->
    <div class="modal" id="receiptModal">
        <div class="modal-content" style="max-width: 400px;">
            <button class="close-btn" onclick="closeReceiptModal()">&times;</button>
            <div class="modal-header">
                <h2>🧾 Nota do Pedido</h2>
                <p>Visualize e imprima a nota</p>
            </div>

            <div id="receiptContent" class="receipt-content">
                <!-- Conteúdo da nota será gerado aqui -->
            </div>

            <div style="text-align: center; margin-top: 30px; display: flex; gap: 15px; justify-content: center;">
                <button class="btn btn-success" onclick="printReceipt()">🖨️ Imprimir</button>
                <button class="btn btn-primary" onclick="finishOrder()">✅ Finalizar Pedido</button>
            </div>
        </div>
    </div>

    <!-- Modal de Alerta Moderno -->
    <div class="modern-modal" id="alertModal">
        <div class="modern-modal-overlay" onclick="closeAlertModal()"></div>
        <div class="modern-modal-content alert-modal">
            <div class="modal-icon" id="alertIcon">ℹ️</div>
            <h3 id="alertTitle">Aviso</h3>
            <p id="alertMessage"></p>
            <button class="modern-btn primary" onclick="closeAlertModal()">OK</button>
        </div>
    </div>

    <!-- Modal de Confirmação Moderno -->
    <div class="modern-modal" id="confirmModal">
        <div class="modern-modal-overlay" onclick="closeConfirmModal(false)"></div>
        <div class="modern-modal-content confirm-modal">
            <div class="modal-icon">⚠️</div>
            <h3 id="confirmTitle">Confirmação</h3>
            <p id="confirmMessage"></p>
            <div class="modal-buttons">
                <button class="modern-btn secondary" onclick="closeConfirmModal(false)">Cancelar</button>
                <button class="modern-btn primary" onclick="closeConfirmModal(true)">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Indicador de Status -->
    <div class="offline-indicator" id="offlineIndicator">
        🔄 Modo Offline - Dados salvos localmente
    </div>

    <script>
        // ===== PROGRESSIVE WEB APP (PWA) =====
        
        // ===== PROGRESSIVE WEB APP (PWA) =====
        
        // Detectar Chrome OS
        const isChromeOS = /CrOS/.test(navigator.userAgent) || 
                          navigator.userAgent.includes('Chrome OS') ||
                          window.location.protocol === 'file:';

        if (isChromeOS || window.location.protocol === 'file:') {
            document.getElementById('chromeOSHelp').style.display = 'block';
            document.getElementById('installInstructions').style.display = 'block';
            document.getElementById('appStatus').textContent = '🖥️ Chrome OS';
        }

        // Função para instalar manualmente no Chrome OS
        document.getElementById('installPrompt').addEventListener('click', () => {
            if (isChromeOS || window.location.protocol === 'file:') {
                // Se for Chrome OS ou arquivo local, mostrar instruções
                document.getElementById('installInstructions').scrollIntoView({ 
                    behavior: 'smooth' 
                });
                
                // Tentar forçar o prompt de instalação
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                } else {
                    // Chrome OS: tentar criar atalho via JavaScript
                    if (navigator.setAppBadge) {
                        // Está rodando como PWA
                        showAlert('Aplicativo já está instalado como PWA!', 'PWA Ativo', 'success');
                    } else {
                        // Mostrar instruções específicas
                        const instructions = `🚀 CHROME OS - INSTALAÇÃO MANUAL:

OPÇÃO 1 - Servidor Local:
• Ctrl + Alt + T (Terminal)
• python3 -m http.server 8000
• Nova aba: localhost:8000
• Abrir arquivo → Criar atalho funciona!

OPÇÃO 2 - Força Bruta:
• Chrome → Menu ⋮
• Mais ferramentas → Criar atalho
• ✅ Marcar "Abrir como janela"

OPÇÃO 3 - Launcher:
• Aperte a tecla do Launcher
• Digite "fonte"
• Adicionar aos favoritos

🎯 Após instalado, procure por "Fonte de Vida" no Launcher!`;
                        showAlert(instructions, 'Como Instalar no Chrome OS', 'info');
                    }
                }
            } else {
                // Prompt normal para outros sistemas
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                }
            }
        });

        // Registrar Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register(
                        'data:application/javascript;base64,' + btoa(`
                            const CACHE_NAME = 'fonte-vida-v1';
                            const urlsToCache = ['/'];
                            
                            self.addEventListener('install', event => {
                                event.waitUntil(
                                    caches.open(CACHE_NAME)
                                        .then(cache => cache.addAll(urlsToCache))
                                );
                            });
                            
                            self.addEventListener('fetch', event => {
                                event.respondWith(
                                    caches.match(event.request)
                                        .then(response => {
                                            if (response) {
                                                return response;
                                            }
                                            return fetch(event.request);
                                        })
                                );
                            });
                        `)
                    );
                    console.log('✅ Service Worker registrado');
                    if (!isChromeOS) {
                        document.getElementById('appStatus').textContent = '📱 PWA Ativo';
                    }
                } catch (error) {
                    console.log('❌ Service Worker falhou:', error);
                }
            });
        }

        // Detectar se é PWA instalada
        window.addEventListener('appinstalled', () => {
            document.getElementById('installPrompt').style.display = 'none';
            document.getElementById('appStatus').textContent = '🚀 App Instalado';
            localStorage.setItem('pwa-installed', 'true');
        });

        // Prompt de instalação
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installPrompt').style.display = 'block';
        });

        document.getElementById('installPrompt').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    console.log('✅ PWA instalado!');
                }
                deferredPrompt = null;
                document.getElementById('installPrompt').style.display = 'none';
            }
        });

        // Verificar se já está instalado
        if (localStorage.getItem('pwa-installed') === 'true' || window.matchMedia('(display-mode: standalone)').matches) {
            document.getElementById('appStatus').textContent = '🚀 App Instalado';
        }

        // Monitor de conectividade
        function updateOnlineStatus() {
            const indicator = document.getElementById('offlineIndicator');
            if (navigator.onLine) {
                indicator.className = 'offline-indicator online';
                indicator.textContent = '✅ Online - Dados sincronizados';
                setTimeout(() => {
                    indicator.style.display = 'none';
                }, 3000);
            } else {
                indicator.className = 'offline-indicator offline';
                indicator.textContent = '📱 Offline - Funcionando normalmente';
            }
        }

        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        
        // ===== SISTEMA DE MODAIS MODERNOS =====
        
        let confirmCallback = null;

        // Modal de Alerta Moderno
        function showAlert(message, title = 'Aviso', type = 'info') {
            const modal = document.getElementById('alertModal');
            const iconElement = document.getElementById('alertIcon');
            const titleElement = document.getElementById('alertTitle');
            const messageElement = document.getElementById('alertMessage');
            
            // Definir ícones e títulos baseados no tipo
            const types = {
                info: { icon: 'ℹ️', title: title || 'Informação' },
                success: { icon: '✅', title: title || 'Sucesso' },
                warning: { icon: '⚠️', title: title || 'Atenção' },
                error: { icon: '❌', title: title || 'Erro' }
            };
            
            const config = types[type] || types.info;
            
            iconElement.textContent = config.icon;
            titleElement.textContent = config.title;
            messageElement.textContent = message;
            
            modal.classList.add('active');
            
            // Auto-focus no botão OK
            setTimeout(() => {
                modal.querySelector('.modern-btn').focus();
            }, 100);
        }

        function closeAlertModal() {
            document.getElementById('alertModal').classList.remove('active');
        }

        // Modal de Confirmação Moderno
        function showConfirm(message, title = 'Confirmação') {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirmModal');
                const titleElement = document.getElementById('confirmTitle');
                const messageElement = document.getElementById('confirmMessage');
                
                titleElement.textContent = title;
                messageElement.textContent = message;
                
                confirmCallback = resolve;
                modal.classList.add('active');
                
                // Auto-focus no botão cancelar
                setTimeout(() => {
                    modal.querySelector('.modern-btn.secondary').focus();
                }, 100);
            });
        }

        function closeConfirmModal(result) {
            document.getElementById('confirmModal').classList.remove('active');
            if (confirmCallback) {
                confirmCallback(result);
                confirmCallback = null;
            }
        }

        // Sistema de Toast Notifications
        function showToast(message, type = 'info', title = '', duration = 4000) {
            const container = document.getElementById('toastContainer');
            
            const types = {
                info: { icon: 'ℹ️', title: title || 'Informação' },
                success: { icon: '✅', title: title || 'Sucesso' },
                warning: { icon: '⚠️', title: title || 'Atenção' },
                error: { icon: '❌', title: title || 'Erro' }
            };
            
            const config = types[type] || types.info;
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span class="toast-icon">${config.icon}</span>
                <div class="toast-content">
                    <div class="toast-title">${config.title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="removeToast(this.parentElement)">×</button>
            `;
            
            container.appendChild(toast);
            
            // Auto-remover após duration
            setTimeout(() => {
                removeToast(toast);
            }, duration);
        }

        function removeToast(toast) {
            if (toast && toast.parentElement) {
                toast.style.animation = 'toastSlideOut 0.3s ease forwards';
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.parentElement.removeChild(toast);
                    }
                }, 300);
            }
        }

        // Fechar modais com ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const alertModal = document.getElementById('alertModal');
                const confirmModal = document.getElementById('confirmModal');
                
                if (alertModal.classList.contains('active')) {
                    closeAlertModal();
                }
                if (confirmModal.classList.contains('active')) {
                    closeConfirmModal(false);
                }
            }
        });

        // ===== SISTEMA PRINCIPAL =====
        // Dados em memória
        let clients = [];
        let products = [];
        let orders = [];
        let settings = {
            companyName: 'Fonte de Vida',
            companyCNPJ: '',
            companyAddress: '',
            companyPhone: '',
            companyEmail: '',
            footerMessage: 'Obrigado pela preferência! Volte sempre!'
        };
        let editingProductId = null;
        let currentOrder = null;
        let db = null;

        // Configuração do IndexedDB
        function initDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('FonteVidaDB', 1);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    // Criar object stores
                    if (!db.objectStoreNames.contains('clients')) {
                        db.createObjectStore('clients', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('products')) {
                        db.createObjectStore('products', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('orders')) {
                        db.createObjectStore('orders', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('settings')) {
                        db.createObjectStore('settings', { keyPath: 'key' });
                    }
                };
            });
        }

        // Salvar dados no IndexedDB
        async function saveData() {
            if (!db) return;
            
            try {
                // Usar put() diretamente sem limpar - mais eficiente e seguro
                for (let client of clients) {
                    await saveToStore('clients', client);
                }
                for (let product of products) {
                    await saveToStore('products', product);
                }
                for (let order of orders) {
                    await saveToStore('orders', order);
                }
                
                // Salvar configurações
                await saveToStore('settings', { key: 'company_settings', data: settings });
                
                // Criar backup automático
                await createBackup();
                
                console.log('✅ Dados salvos com segurança no IndexedDB');
            } catch (error) {
                console.error('❌ Erro ao salvar dados:', error);
                showAlert('Erro ao salvar dados. Tente novamente.', 'Erro', 'error');
            }
        }

        // Funções auxiliares do IndexedDB
        function saveToStore(storeName, data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.put(data); // Mudança: put() em vez de add()
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        function clearStore(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.clear();
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        function loadFromStore(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function deleteFromStore(storeName, key) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.delete(key);
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // Carregar dados do IndexedDB
        async function loadData() {
            if (!db) return;
            
            try {
                clients = await loadFromStore('clients');
                products = await loadFromStore('products');
                orders = await loadFromStore('orders');
                
                // Carregar configurações
                const settingsData = await loadFromStore('settings');
                if (settingsData.length > 0) {
                    const savedSettings = settingsData.find(s => s.key === 'company_settings');
                    if (savedSettings) {
                        settings = { ...settings, ...savedSettings.data };
                    }
                }
                
                // Se não há produtos, criar os padrão
                if (products.length === 0) {
                    products = [
                        {"id": 1, "name": "Galão 20L", "price": 8.00},
                        {"id": 2, "name": "Galão 10L", "price": 5.00},
                        {"id": 3, "name": "Copo 200ml", "price": 0.50}
                    ];
                    await saveData();
                }
                
                console.log('✅ Dados carregados do IndexedDB');
            } catch (error) {
                console.error('❌ Erro ao carregar dados:', error);
            }
        }

        // Backup e Restore
        async function exportBackup() {
            const backupData = {
                clients: clients,
                products: products,
                orders: orders,
                settings: settings,
                timestamp: new Date().toISOString(),
                version: '1.0'
            };
            
            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `backup_fonte_vida_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showToast('Backup criado com sucesso!\nGuarde este arquivo em local seguro.', 'success', 'Backup Exportado');
        }

        function importBackup() {
            document.getElementById('backupFileInput').click();
        }

        async function handleBackupFile(input) {
            const file = input.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const backupData = JSON.parse(text);
                
                // Verificar estrutura do backup
                if (!backupData.clients || !backupData.products || !backupData.orders) {
                    throw new Error('Arquivo de backup inválido');
                }
                
                const confirmMessage = `⚠️ ATENÇÃO!

Isso vai substituir TODOS os dados atuais pelos dados do backup.

Backup de: ${new Date(backupData.timestamp).toLocaleString('pt-BR')}
Clientes: ${backupData.clients.length}
Produtos: ${backupData.products.length}
Pedidos: ${backupData.orders.length}

Deseja continuar?`;
                
                const confirmRestore = await showConfirm(confirmMessage, 'Restaurar Backup');
                
                if (!confirmRestore) return;
                
                // Restaurar dados
                clients = backupData.clients;
                products = backupData.products;
                orders = backupData.orders;
                if (backupData.settings) {
                    settings = { ...settings, ...backupData.settings };
                }
                
                await saveData();
                
                // Recarregar interface
                loadClients();
                loadProducts();
                loadDashboard();
                loadSettings();
                
                showAlert('Backup restaurado com sucesso!', 'Restauração Completa', 'success');
                
            } catch (error) {
                console.error('Erro ao restaurar backup:', error);
                showAlert('Erro ao restaurar backup. Verifique se o arquivo está correto.', 'Erro na Restauração', 'error');
            }
        }

        // Navegação entre páginas
        function showPage(pageName) {
            // Esconder todas as páginas
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            
            // Mostrar página selecionada
            document.getElementById(pageName).classList.add('active');
            event.target.classList.add('active');
            
            // Carregar dados da página
            if (pageName === 'home') loadClients();
            if (pageName === 'dashboard') loadDashboard();
            if (pageName === 'products') loadProducts();
            if (pageName === 'settings') loadSettings();
        }

        // Carregar clientes
        function loadClients() {
            const grid = document.getElementById('clientsGrid');
            grid.innerHTML = '';

            if (clients.length === 0) {
                grid.innerHTML = '<p style="text-align: center; color: #666; font-size: 1.2em; grid-column: 1/-1;">Nenhum cliente cadastrado ainda. Clique em "Fazer Novo Pedido" para começar!</p>';
                return;
            }

            clients.forEach(client => {
                const clientCard = document.createElement('div');
                clientCard.className = 'client-card';
                clientCard.innerHTML = `
                    <div class="client-name">${client.name}</div>
                    <div class="client-address">
                        ${client.phone ? `📞 ${phoneMask(client.phone)}<br>` : ''}
                        📍 ${client.address}${client.complement ? ', ' + client.complement : ''}<br>
                        ${client.neighborhood || ''}
                    </div>
                    <div class="client-actions">
                        <button class="btn btn-success" onclick="newOrderForClient('${client.id}')">🛒 Novo Pedido</button>
                        <button class="btn btn-primary" onclick="viewClientHistory('${client.id}')">📋 Histórico</button>
                    </div>
                `;
                grid.appendChild(clientCard);
            });
        }

        // Filtrar clientes
        function filterClients() {
            const nameFilter = document.getElementById('searchName').value.toLowerCase();
            const streetFilter = document.getElementById('searchStreet').value.toLowerCase();
            
            const filteredClients = clients.filter(client => 
                client.name.toLowerCase().includes(nameFilter) &&
                client.address.toLowerCase().includes(streetFilter)
            );

            const grid = document.getElementById('clientsGrid');
            grid.innerHTML = '';

            filteredClients.forEach(client => {
                const clientCard = document.createElement('div');
                clientCard.className = 'client-card';
                clientCard.innerHTML = `
                    <div class="client-name">${client.name}</div>
                    <div class="client-address">
                        ${client.phone ? `📞 ${phoneMask(client.phone)}<br>` : ''}
                        📍 ${client.address}${client.complement ? ', ' + client.complement : ''}<br>
                        ${client.neighborhood || ''}
                    </div>
                    <div class="client-actions">
                        <button class="btn btn-success" onclick="newOrderForClient('${client.id}')">🛒 Novo Pedido</button>
                        <button class="btn btn-primary" onclick="viewClientHistory('${client.id}')">📋 Histórico</button>
                    </div>
                `;
                grid.appendChild(clientCard);
            });
        }

        // Modal de pedido
        function openOrderModal(clientData = null) {
            document.getElementById('orderModal').classList.add('active');
            document.getElementById('orderProducts').innerHTML = '';
            document.getElementById('orderForm').reset();
            
            if (clientData) {
                document.getElementById('clientName').value = clientData.name;
                document.getElementById('clientPhone').value = clientData.phone ? phoneMask(clientData.phone) : '';
                document.getElementById('clientAddress').value = clientData.address;
                document.getElementById('clientComplement').value = clientData.complement || '';
                document.getElementById('clientNeighborhood').value = clientData.neighborhood || '';
            }
            
            addProductToOrder(); // Adicionar primeiro produto
            
            // Auto-focus no primeiro campo
            setTimeout(() => {
                document.getElementById('clientName').focus();
            }, 100);
        }

        // Modal de pedido - função única atualizada
        function closeOrderModal() {
            document.getElementById('orderModal').classList.remove('active');
        }

        function newOrderForClient(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (client) {
                openOrderModal(client);
            }
        }

        // Adicionar produto ao pedido
        function addProductToOrder() {
            const container = document.getElementById('orderProducts');
            const productDiv = document.createElement('div');
            productDiv.className = 'product-item';
            
            let productOptions = products.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            
            productDiv.innerHTML = `
                <select class="form-input" required>
                    <option value="">Selecione um produto</option>
                    ${productOptions}
                </select>
                <input type="number" class="form-input" placeholder="Quantidade" min="1" value="1" required>
                <input type="text" class="form-input" placeholder="Preço unitário" required>
                <button type="button" class="remove-product-btn" onclick="removeProductFromOrder(this)">🗑️</button>
            `;
            
            // Auto-preencher preço quando produto for selecionado
            const select = productDiv.querySelector('select');
            const priceInput = productDiv.querySelector('input[placeholder="Preço unitário"]');
            
            select.addEventListener('change', function() {
                const productId = this.value;
                const product = products.find(p => p.id == productId);
                if (product) {
                    priceInput.value = numberToMoney(product.price);
                }
            });
            
            // Aplicar máscara no preço
            priceInput.addEventListener('input', function() {
                this.value = moneyMask(this.value);
            });
            
            container.appendChild(productDiv);
        }

        function removeProductFromOrder(button) {
            button.parentElement.remove();
        }

        // Enviar pedido
        document.getElementById('orderForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const clientData = {
                id: Date.now().toString(),
                name: document.getElementById('clientName').value,
                phone: document.getElementById('clientPhone').value.replace(/\D/g, ''), // Remover máscara
                address: document.getElementById('clientAddress').value,
                complement: document.getElementById('clientComplement').value,
                neighborhood: document.getElementById('clientNeighborhood').value
            };

            // Verificar se cliente já existe
            let existingClient = clients.find(c => 
                c.name.toLowerCase() === clientData.name.toLowerCase() && 
                c.address.toLowerCase() === clientData.address.toLowerCase()
            );

            if (!existingClient) {
                clients.push(clientData);
                existingClient = clientData;
            }

            // Coletar produtos do pedido
            const productItems = document.querySelectorAll('#orderProducts .product-item');
            const orderItems = [];
            let total = 0;

            productItems.forEach(item => {
                const select = item.querySelector('select');
                const quantity = parseInt(item.querySelector('input[placeholder="Quantidade"]').value);
                const priceText = item.querySelector('input[placeholder="Preço unitário"]').value;
                const price = moneyToNumber(priceText);
                
                if (select.value && quantity && price) {
                    const product = products.find(p => p.id == select.value);
                    orderItems.push({
                        productId: select.value,
                        productName: product.name,
                        quantity: quantity,
                        unitPrice: price,
                        total: quantity * price
                    });
                    total += quantity * price;
                }
            });

            // Criar pedido
            currentOrder = {
                id: Date.now().toString(),
                clientId: existingClient.id,
                clientName: existingClient.name,
                clientPhone: existingClient.phone,
                clientAddress: existingClient.address,
                clientComplement: existingClient.complement,
                clientNeighborhood: existingClient.neighborhood,
                items: orderItems,
                total: total,
                notes: document.getElementById('orderNotes').value,
                date: new Date().toISOString()
            };

            // Mostrar nota para impressão
            showReceipt(currentOrder);
        });

        // Configurações
        function loadSettings() {
            document.getElementById('companyName').value = settings.companyName;
            document.getElementById('companyCNPJ').value = settings.companyCNPJ;
            document.getElementById('companyAddress').value = settings.companyAddress;
            document.getElementById('companyPhone').value = settings.companyPhone;
            document.getElementById('companyEmail').value = settings.companyEmail;
            document.getElementById('footerMessage').value = settings.footerMessage;
            
            // Aplicar máscaras nos valores carregados
            if (settings.companyPhone) {
                document.getElementById('companyPhone').value = phoneMask(settings.companyPhone);
            }
            if (settings.companyCNPJ) {
                document.getElementById('companyCNPJ').value = cnpjMask(settings.companyCNPJ);
            }
        }

        // Salvar configurações
        document.getElementById('settingsForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            settings.companyName = document.getElementById('companyName').value;
            settings.companyCNPJ = document.getElementById('companyCNPJ').value.replace(/\D/g, ''); // Remover máscara
            settings.companyAddress = document.getElementById('companyAddress').value;
            settings.companyPhone = document.getElementById('companyPhone').value.replace(/\D/g, ''); // Remover máscara
            settings.companyEmail = document.getElementById('companyEmail').value;
            settings.footerMessage = document.getElementById('footerMessage').value;
            
            await saveData();
            showToast('Configurações salvas com sucesso!', 'success', 'Configurações');
        });

        // Sistema de Cupom Não Fiscal - Estilo Tradicional
        function showReceipt(order) {
            const receiptContent = document.getElementById('receiptContent');
            const now = new Date(order.date);
            const orderNumber = order.id.slice(-6);
            
            let receiptHTML = `
<div class="receipt-center receipt-bold receipt-medium">${settings.companyName.toUpperCase()}</div>
${settings.companyCNPJ ? `<div class="receipt-center receipt-small">CNPJ: ${cnpjMask(settings.companyCNPJ)}</div>` : ''}
${settings.companyAddress ? `<div class="receipt-center receipt-small">${settings.companyAddress}</div>` : ''}
${settings.companyPhone ? `<div class="receipt-center receipt-small">Tel: ${phoneMask(settings.companyPhone)}</div>` : ''}

<div class="receipt-separator">----------------------------------------</div>

<div class="receipt-center receipt-bold">CUPOM NAO FISCAL</div>
<div class="receipt-center receipt-small"># ${orderNumber}</div>

<div class="receipt-separator">----------------------------------------</div>

<div class="receipt-left receipt-small">
Data: ${now.toLocaleDateString('pt-BR')}    Hora: ${now.toLocaleTimeString('pt-BR')}
</div>

<div class="receipt-separator">........................................</div>

<div class="receipt-left receipt-bold">CLIENTE:</div>
<div class="receipt-left">${order.clientName}</div>
${order.clientPhone ? `<div class="receipt-left receipt-small">Tel: ${phoneMask(order.clientPhone)}</div>` : ''}
<div class="receipt-left receipt-small">${order.clientAddress}${order.clientComplement ? ', ' + order.clientComplement : ''}</div>
${order.clientNeighborhood ? `<div class="receipt-left receipt-small">${order.clientNeighborhood}</div>` : ''}

<div class="receipt-separator">........................................</div>

<div class="receipt-left receipt-bold">PRODUTOS:</div>
`;

            order.items.forEach((item, index) => {
                const itemTotal = item.quantity * item.unitPrice;
                receiptHTML += `
<div class="receipt-left">${item.productName}</div>
<div class="receipt-item-line">
    <span>${item.quantity} x R$ ${item.unitPrice.toFixed(2)}</span>
    <span>R$ ${itemTotal.toFixed(2)}</span>
</div>
`;
            });

            receiptHTML += `
<div class="receipt-separator">----------------------------------------</div>

<div class="receipt-total-line">
    <span class="receipt-large">TOTAL:</span>
    <span class="receipt-large">R$ ${order.total.toFixed(2)}</span>
</div>

<div class="receipt-separator">----------------------------------------</div>
`;

            if (order.notes) {
                receiptHTML += `
<div class="receipt-left receipt-bold receipt-small">OBS:</div>
<div class="receipt-left receipt-small">${order.notes}</div>

<div class="receipt-separator">........................................</div>
`;
            }

            receiptHTML += `
<div class="receipt-center receipt-small">${settings.footerMessage}</div>

<div class="receipt-separator">........................................</div>

<div class="receipt-center receipt-small">
${now.toLocaleDateString('pt-BR')} - ${now.toLocaleTimeString('pt-BR')}
</div>

<div class="receipt-center receipt-small">
* OBRIGADO E VOLTE SEMPRE *
</div>`;
            
            receiptContent.innerHTML = receiptHTML;
            document.getElementById('receiptModal').classList.add('active');
        }

        function printReceipt() {
            window.print();
        }

        async function finishOrder() {
            if (currentOrder) {
                orders.push(currentOrder);
                await saveData();
                
                closeReceiptModal();
                closeOrderModal();
                loadClients();
                
                showToast('Pedido finalizado com sucesso!', 'success', 'Pedido Confirmado');
                currentOrder = null;
            }
        }

        function closeReceiptModal() {
            document.getElementById('receiptModal').classList.remove('active');
        }
        function loadDashboard() {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            
            const weekAgo = new Date(today);
            weekAgo.setDate(today.getDate() - 7);
            
            const monthAgo = new Date(today);
            monthAgo.setMonth(today.getMonth() - 1);

            const todayOrders = orders.filter(o => o.date.split('T')[0] === todayStr);
            const weekOrders = orders.filter(o => new Date(o.date) >= weekAgo);
            const monthOrders = orders.filter(o => new Date(o.date) >= monthAgo);

            const todayRevenue = todayOrders.reduce((sum, o) => sum + o.total, 0);

            document.getElementById('todayOrders').textContent = todayOrders.length;
            document.getElementById('weekOrders').textContent = weekOrders.length;
            document.getElementById('monthOrders').textContent = monthOrders.length;
            document.getElementById('todayRevenue').textContent = `R$ ${todayRevenue.toFixed(2)}`;
        }

        // Exportar CSV
        function exportCSV() {
            let csv = 'Data,Cliente,Produtos,Total\n';
            
            orders.forEach(order => {
                const date = new Date(order.date).toLocaleDateString('pt-BR');
                const products = order.items.map(item => `${item.productName} (${item.quantity}x)`).join('; ');
                csv += `${date},"${order.clientName}","${products}",R$ ${order.total.toFixed(2)}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `relatorio_fonte_vida_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // Produtos
        function loadProducts() {
            const tbody = document.getElementById('productsTable');
            tbody.innerHTML = '';

            products.forEach(product => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product.name}</td>
                    <td>R$ ${product.price.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-primary" onclick="editProduct(${product.id})" style="margin-right: 10px;">✏️ Editar</button>
                        <button class="btn" onclick="deleteProduct(${product.id})" style="background: #f44336; color: white;">🗑️ Excluir</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function openProductModal(product = null) {
            document.getElementById('productModal').classList.add('active');
            
            if (product) {
                document.getElementById('productModalTitle').textContent = '✏️ Editar Produto';
                document.getElementById('productName').value = product.name;
                document.getElementById('productPrice').value = numberToMoney(product.price);
                editingProductId = product.id;
            } else {
                document.getElementById('productModalTitle').textContent = '➕ Adicionar Produto';
                document.getElementById('productForm').reset();
                editingProductId = null;
            }
            
            // Auto-focus no primeiro campo
            setTimeout(() => {
                document.getElementById('productName').focus();
            }, 100);
        }

        function closeProductModal() {
            document.getElementById('productModal').classList.remove('active');
        }

        function editProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (product) {
                openProductModal(product);
            }
        }

        async function deleteProduct(productId) {
            const confirmDelete = await showConfirm('Tem certeza que deseja excluir este produto?', 'Excluir Produto');
            
            if (confirmDelete) {
                // Remover do array local
                products = products.filter(p => p.id !== productId);
                
                // Remover do IndexedDB
                try {
                    await deleteFromStore('products', productId);
                    console.log('✅ Produto removido do IndexedDB');
                } catch (error) {
                    console.error('❌ Erro ao remover produto:', error);
                }
                
                await saveData();
                loadProducts();
                showToast('Produto excluído com sucesso!', 'success', 'Produto Removido');
            }
        }

        // Enviar produto
        document.getElementById('productForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('productName').value;
            const priceText = document.getElementById('productPrice').value;
            const price = moneyToNumber(priceText);

            if (editingProductId) {
                // Editar produto
                const product = products.find(p => p.id === editingProductId);
                product.name = name;
                product.price = price;
            } else {
                // Novo produto
                const newProduct = {
                    id: Date.now(),
                    name: name,
                    price: price
                };
                products.push(newProduct);
            }

            await saveData();
            closeProductModal();
            loadProducts();
            showToast('Produto salvo com sucesso!', 'success', 'Produto');
        });

        function viewClientHistory(clientId) {
            const clientOrders = orders.filter(o => o.clientId === clientId);
            const client = clients.find(c => c.id === clientId);
            
            if (clientOrders.length === 0) {
                showAlert('Este cliente ainda não fez nenhum pedido.', 'Histórico Vazio', 'info');
                return;
            }

            let historyText = `📋 Histórico de ${client.name}\n\n`;
            clientOrders.forEach(order => {
                const date = new Date(order.date).toLocaleDateString('pt-BR');
                historyText += `📅 ${date} - Total: R$ ${order.total.toFixed(2)}\n`;
                order.items.forEach(item => {
                    historyText += `   • ${item.productName} - ${item.quantity}x R$ ${item.unitPrice.toFixed(2)}\n`;
                });
                historyText += '\n';
            });

            showAlert(historyText, `Histórico de ${client.name}`, 'info');
        }

        // Sistema de Backup Automático
        async function createBackup() {
            try {
                const backupData = {
                    clients: clients,
                    products: products,
                    orders: orders,
                    settings: settings,
                    timestamp: new Date().toISOString(),
                    version: '1.0'
                };
                
                // Salvar backup no IndexedDB usando put()
                await saveToStore('settings', { key: 'last_backup', data: backupData });
                
                console.log('🔄 Backup automático criado');
            } catch (error) {
                console.error('❌ Erro no backup automático:', error);
            }
        }

        // Inicializar aplicação
        let isInitialized = false;
        
        document.addEventListener('DOMContentLoaded', async function() {
            if (isInitialized) return;
            
            try {
                console.log('🚀 Iniciando Fonte de Vida...');
                
                // Inicializar banco de dados
                await initDatabase();
                console.log('✅ IndexedDB inicializado');
                
                // Carregar dados
                await loadData();
                console.log('✅ Dados carregados');
                
                // Marcar como inicializado
                isInitialized = true;
                
                // Carregar interface
                loadClients();
                
                // Aplicar máscaras e validações
                setupInputMasks();
                setupValidations();
                
                console.log('🎉 Sistema pronto!');
                
            } catch (error) {
                console.error('❌ Erro na inicialização:', error);
                showAlert('Erro ao inicializar o sistema. Verifique o console e recarregue a página.', 'Erro de Inicialização', 'error');
            }
        });

        // ===== SISTEMA DE MÁSCARAS E VALIDAÇÕES =====
        
        // Máscara de telefone
        function phoneMask(value) {
            return value
                .replace(/\D/g, '')
                .replace(/(\d{2})(\d)/, '($1) $2')
                .replace(/(\d{4})(\d)/, '$1-$2')
                .replace(/(\d{4})-(\d)(\d{4})/, '$1$2-$3')
                .replace(/(-\d{4})\d+?$/, '$1');
        }

        // Máscara de CNPJ
        function cnpjMask(value) {
            return value
                .replace(/\D/g, '')
                .replace(/(\d{2})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d)/, '$1/$2')
                .replace(/(\d{4})(\d)/, '$1-$2')
                .replace(/(-\d{2})\d+?$/, '$1');
        }

        // Máscara de valor monetário
        function moneyMask(value) {
            let v = value.replace(/\D/g, '');
            v = (v/100).toFixed(2) + '';
            v = v.replace(".", ",");
            v = v.replace(/(\d)(\d{3})(\d{3}),/g, "$1.$2.$3,");
            v = v.replace(/(\d)(\d{3}),/g, "$1.$2,");
            return 'R$ ' + v;
        }

        // Converter valor monetário para número
        function moneyToNumber(value) {
            return parseFloat(value.replace(/[R$\s.]/g, '').replace(',', '.')) || 0;
        }

        // Converter número para valor monetário
        function numberToMoney(value) {
            return 'R$ ' + parseFloat(value).toFixed(2).replace('.', ',').replace(/(\d)(\d{3})(\d{3}),/g, "$1.$2.$3,").replace(/(\d)(\d{3}),/g, "$1.$2,");
        }

        // Aplicar máscaras nos inputs
        function setupInputMasks() {
            // Máscara de telefone
            document.addEventListener('input', function(e) {
                if (e.target.id === 'clientPhone' || e.target.id === 'companyPhone') {
                    e.target.value = phoneMask(e.target.value);
                }
                
                if (e.target.id === 'companyCNPJ') {
                    e.target.value = cnpjMask(e.target.value);
                }
                
                if (e.target.id === 'productPrice' || e.target.placeholder === 'Preço unitário') {
                    e.target.value = moneyMask(e.target.value);
                }
            });
        }

        // Validações visuais
        function setupValidations() {
            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('required')) {
                    if (e.target.value.trim()) {
                        e.target.classList.remove('invalid');
                        e.target.classList.add('valid');
                    } else {
                        e.target.classList.remove('valid');
                        e.target.classList.add('invalid');
                    }
                }
            });

            // Validação de email
            document.addEventListener('input', function(e) {
                if (e.target.type === 'email') {
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (emailRegex.test(e.target.value) || e.target.value === '') {
                        e.target.classList.remove('invalid');
                        e.target.classList.add('valid');
                    } else {
                        e.target.classList.remove('valid');
                        e.target.classList.add('invalid');
                    }
                }
            });
        }

        
    </script>
    <script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
            navigator.serviceWorker.register('/service-worker.js').then(function(registration) {
                // Registration was successful
                console.log('ServiceWorker registration successful with scope: ', registration.scope);
            }, function(err) {
                // registration failed :(
                console.log('ServiceWorker registration failed: ', err);
            });
        });
    }
</script>
</body>
</html>
